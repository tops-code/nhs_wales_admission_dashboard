---
title: "Admissions in NHS Wales"
format: 
  dashboard:
      scrolling: False 
      logo: theme/NHS_Wales_logo.svg.png
      nav-buttons:
      - icon: twitter
        href: https://x.com/_togbonna
      - icon: linkedin
        href: https://www.linkedin.com/in/toochukwu-ogbonna-939266207/
      - icon: gitlab
        href: https://github.com/tops-code
theme: [sandstone, theme/custom.scss]
fig-width: 10
fig-asp: 0.3
server: shiny
---

```{r}
#| label: load-packages
#| context: setup
#| message: false
library(tidyverse)
library(readxl)
library(DT)
library(gt)
library(shinyWidgets)
library(bslib)
library(bsicons)
library(naniar)
library(here)
library(patchwork)
theme_custom <- function (base_size = 15, base_family = "Atkinson Hyperlegible") {
    half_line <- base_size/2
  theme(
    line = element_blank(),
    rect = element_rect(fill = "#ffffff", color = NA,
                        linewidth = NA, linetype = 1),
    text = element_text(family = base_family, face = "plain",
                        color = "black", size = base_size,
                        lineheight = .9, hjust = .5, vjust = .5,
                        angle = 0, margin = margin(), debug = FALSE),
    axis.line = element_blank(),
    axis.line.x = NULL,
    axis.line.y = NULL,
    axis.text = element_text(size = base_size, color = "gray30"),
    axis.text.x = element_text(size = base_size * 0.5, margin = margin(t = .8 * half_line/2),
                               vjust = 1),
    axis.text.x.top = element_text(margin = margin(b = .8 * half_line/2),
                                   vjust = 0),
    axis.text.y = element_text(margin = margin(r = .8 * half_line/2),
                               hjust = 1),
    axis.text.y.right = element_text(margin = margin(l = .8 * half_line/2),
                                     hjust = 0),
    axis.ticks = element_line(color = "gray30", linewidth = .7),
    axis.ticks.length = unit(half_line / 1.5, "pt"),
    axis.ticks.length.x = NULL,
    axis.ticks.length.x.top = NULL,
    axis.ticks.length.x.bottom = NULL,
    axis.ticks.length.y = NULL,
    axis.ticks.length.y.left = NULL,
    axis.ticks.length.y.right = NULL,
    axis.title.x = element_blank(),
    axis.title.x.top = element_text(margin = margin(b = half_line),
                                    vjust = 0),
    axis.title.y = element_blank(),
    axis.title.y.right = element_text(angle = -90, vjust = 0,
                                      margin = margin(l = half_line)),
    legend.background = element_rect(color = NA),
    legend.spacing = unit(.4, "cm"),
    legend.spacing.x = NULL,
    legend.spacing.y = NULL,
    legend.margin = margin(.2, .2, .2, .2, "cm"),
    legend.key = element_rect(fill = "gray95", color = "white"),
    legend.key.size = unit(1.2, "lines"),
    legend.key.height = NULL,
    legend.key.width = NULL,
    legend.text = element_text(size = rel(.8)),
    legend.text.align = NULL,
    legend.title = element_text(hjust = 0),
    legend.title.align = NULL,
    legend.position = "right",
    legend.direction = NULL,
    legend.justification = "center",
    legend.box = NULL,
    legend.box.margin = margin(0, 0, 0, 0, "cm"),
    legend.box.background = element_blank(),
    legend.box.spacing = unit(.4, "cm"),
    panel.background = element_rect(fill = NA, color = NA),
    panel.border = element_rect(color = NULL,
                                fill = NA, linewidth = NULL),
    panel.grid.major = element_line(color = "gray90", linewidth = 1),
    panel.grid.minor = element_line(color = "gray90", linewidth = .5,
                                    linetype = "dashed"),
    panel.spacing = unit(base_size, "pt"),
    panel.spacing.x = NULL,
    panel.spacing.y = NULL,
    panel.ontop = FALSE,
    strip.background = element_rect(fill = "white", color = "gray30"),
    strip.text = element_text(color = "black", size = base_size),
    strip.text.x = element_text(margin = margin(t = half_line,
                                                b = half_line)),
    strip.text.y = element_text(angle = -90,
                                margin = margin(l = half_line,
                                                r = half_line)),
    strip.text.y.left = element_text(angle = 90),
    strip.placement = "inside",
    strip.placement.x = NULL,
    strip.placement.y = NULL,
    strip.switch.pad.grid = unit(0.1, "cm"),
    strip.switch.pad.wrap = unit(0.1, "cm"),
    plot.background = element_rect(color = NA),
    plot.title = element_text(size = base_size * 1.8, hjust = 0,
                              vjust = 1, face = "bold",
                              margin = margin(b = half_line/2)),
    plot.title.position = "plot",
    plot.subtitle = element_text(size = base_size * 1.3,
                                 hjust = 0, vjust = 1,
                                 margin = margin(b = half_line /2)),
    plot.caption = element_text(size = rel(0.9), hjust = 1, vjust = 1,
                                margin = margin(t = half_line * .9)),
    plot.caption.position = "plot",
    plot.tag = element_text(size = rel(1.2), hjust = .5, vjust = .5),
    plot.tag.position = "topleft",
    plot.margin = margin(20, 30, 20, 30),
    complete = TRUE
  )
}
colors<-c('#87CEEB', '#0D3B66', '#254441', '#DB504A', '#F5F4EF')
```

```{r}
#| label: load-data
#| context: data
#| message: false


##
  health_board <- c(
    "Aneurin Bevan University Health Board",
    "Aneurin Bevan University Health Board",
    "Aneurin Bevan University Health Board",
    "Aneurin Bevan University Health Board",
    "Aneurin Bevan University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Cardiff and Vale University Health Board",
    "Cardiff and Vale University Health Board",
    "Cwm Taf Morgannwg University Health Board",
    "Cwm Taf Morgannwg University Health Board",
    "Cwm Taf Morgannwg University Health Board",
    "Hywel Dda University Health Board",
    "Hywel Dda University Health Board",
    "Hywel Dda University Health Board",
    "Powys Teaching Health Board",
    "Swansea Bay University Health Board",
    "Swansea Bay University Health Board"
  )
  
  area_served <- c(
    "Blaenau Gwent",
    "Caerphilly",
    "Monmouthshire",
    "Newport",
    "Torfaen",
    "Anglesey",
    "Gwynedd",
    "Conwy",
    "Denbighshire",
    "Flintshire",
    "Wrexham",
    "Cardiff",
    "Vale of Glamorgan",
    "Bridgend",
    "Merthyr Tydfil",
    "Rhondda Cynon Taf",
    "Carmarthenshire",
    "Ceredigion",
    "Pembrokeshire",
    "Powys",
    "Swansea",
    "Neath Port Talbot"
  )
  
# Create the data frame
welsh_health_boards <- data.frame(
    health_board = health_board,
    area_served = area_served)

##functions to get the data and partly clean them
get_data<-function(df){
  
  health_board <- c(
    "Aneurin Bevan University Health Board",
    "Aneurin Bevan University Health Board",
    "Aneurin Bevan University Health Board",
    "Aneurin Bevan University Health Board",
    "Aneurin Bevan University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Cardiff and Vale University Health Board",
    "Cardiff and Vale University Health Board",
    "Cwm Taf Morgannwg University Health Board",
    "Cwm Taf Morgannwg University Health Board",
    "Cwm Taf Morgannwg University Health Board",
    "Hywel Dda University Health Board",
    "Hywel Dda University Health Board",
    "Hywel Dda University Health Board",
    "Powys Teaching Health Board",
    "Swansea Bay University Health Board",
    "Swansea Bay University Health Board"
  )
  
  area_served <- c(
    "Blaenau Gwent",
    "Caerphilly",
    "Monmouthshire",
    "Newport",
    "Torfaen",
    "Anglesey",
    "Gwynedd",
    "Conwy",
    "Denbighshire",
    "Flintshire",
    "Wrexham",
    "Cardiff",
    "Vale of Glamorgan",
    "Bridgend",
    "Merthyr Tydfil",
    "Rhondda Cynon Taf",
    "Carmarthenshire",
    "Ceredigion",
    "Pembrokeshire",
    "Powys",
    "Swansea",
    "Neath Port Talbot"
  )
  
  # Create the data frame
  welsh_health_boards <- data.frame(
    health_board = health_board,
    area_served = area_served
  )
  
  main_df<-df|>rename(local_authority = "...2", 
                      local_auth_two = "...3",
                      Zero_to_fifteen =  "All ages...4",
                      sixteen_to_sixtyfour = "...5",
                      SixtyFive_and_over =  "...6" ,
                      Total = "All ages...7")|>
    select (local_authority:Total)|>
    slice(3:n())|>
    rowwise() %>%
    mutate(main_local = case_when(
      is.na(local_auth_two) & !is.na(local_authority) ~ local_authority,
      .default = str_trim(str_split(local_auth_two, 'U')[[1]][1])
    )) %>%
    
    mutate(main_local = case_when(
      main_local == "The Vale of Glamorgan" ~ "Vale of Glamorgan",
      main_local == "Isle of Anglesey" ~ 'Anglesey',
      main_local == "Rhondda Cynon Taff"  ~ "Rhondda Cynon Taf"  ,
      .default = main_local
    )) |>
    # Remove the rowwise structure
    ungroup() |>
    select (main_local, Zero_to_fifteen, sixteen_to_sixtyfour, SixtyFive_and_over, Total)|>
    group_by(main_local)|>
    summarise(
      Zero_to_fifteen = sum(as.numeric(Zero_to_fifteen)),
      sixteen_to_sixtyfour = sum(as.numeric(sixteen_to_sixtyfour)),
      SixtyFive_and_over = sum(as.numeric(SixtyFive_and_over)),
      Total = sum(as.numeric(Total))
    ) |>ungroup()|>
    left_join(welsh_health_boards, join_by(main_local == area_served))
  
  
  return(
    main_df
  )
}
get_data_from_nhs<-function(data_location, disease_source, res_or_provider){
  
  health_boards<-c("Aneurin Bevan ULHB", 
                   'Betsi Cadwaladr ULHB', 
                   'Cardiff & Vale ULHB',
                   'Cwm Taf Morgannwg ULHB',
                   'Hywel Dda ULHB',
                   'Powys Teaching LHB',
                   'Swansea Bay ULHB')
  combined_df <- map_dfr(health_boards,
                         ~ read_excel(data_location, sheet = .x, skip = 3) |>
    mutate(
      health_board = case_when(
        .x == "Cardiff & Vale ULHB" ~ str_replace(str_replace(.x, "&", "and"), "ULHB", "University Health Board"),
        .x == "Powys Teaching LHB" ~ str_replace(.x, "LHB", "Health Board"),
        TRUE ~ str_replace(.x, "ULHB", "University Health Board"))
                           
      ) |>replace_with_na_all(condition = ~.x %in% c('*', "**", "-")) |>
      mutate(disease_source = disease_source,
             resident_or_provider = res_or_provider)
  )
  
}


hb<-unique(health_board)
fem_pop<-get_data(read_excel("data/female.xlsx"))|>group_by(health_board)|>summarise(main_total_fem = sum(Total))
male_pop <- get_data(read_excel("data/males.xlsx"))|>group_by(health_board)|>summarise(main_total_male = sum(Total))
total_pop<-get_data(read_excel("data/total.xlsx"))|>group_by(health_board)|>summarise(main_total = sum(Total))

# test<-c("Aneurin Bevan ULHB", 'Betsi Cadwaladr ULHB', 'Cardiff & Vale ULHB','Cwm Taf Morgannwg ULHB','Hywel Dda ULHB',"Powys Teaching LHB",'Swansea Bay ULHB')

# combined_df <- map_dfr(
#   test,
#   ~ read_excel("data/ExcelTables11R_2023_LHB.xlsx", sheet = .x, skip = 3) |>
#     mutate(
#       health_board = case_when(
#         .x == "Cardiff & Vale ULHB" ~ str_replace(str_replace(.x, "&", "and"), "ULHB", "University Health Board"),
#         .x == "Powys Teaching LHB" ~ str_replace(.x, "LHB", "Health Board"),
#         TRUE ~ str_replace(.x, "ULHB", "University Health Board")
#       )|>
#     )
# )

disease_cat<-read.csv(here('data', 'main.csv'))
external_r<-get_data_from_nhs(here::here('data', "ExcelTables11R_2023_LHB.xlsx"), 'External', "Health board Resident")
external_p<-get_data_from_nhs(here('data', "ExcelTables11P_2023_LHB.xlsx"),  'External', "Health board Provider")
primary_r<-get_data_from_nhs(here::here('data', "ExcelTables3R_2023_LHB.xlsx"),  'Primary', "Health board Resident")
primary_p<-get_data_from_nhs(here::here('data', "ExcelTables3P_2023_LHB.xlsx"), 'Primary', "Health board Provider")

external_combined<-union(external_p, external_r)|>na.omit()|>mutate(disease = str_sub(Name, 1, 3))|>left_join(disease_cat, join_by(disease == Code))

primary_comb<-union(primary_p, primary_r)|>
  na.omit()|>
  mutate(disease = str_sub(Name, 1, 3))|>
  left_join(disease_cat, join_by(disease == Code))|>
  mutate( main_diag = case_when(
    is.na(DiagnosisType) & (lag(str_sub(disease, 1, 1)) == str_sub(disease, 1, 1) | lead(str_sub(disease, 1, 1)) == str_sub(disease, 1, 1)) ~ lag(DiagnosisType),
    .default = DiagnosisType))

df_prim<-primary_comb|>filter(str_detect(Name, 'Total'))|>left_join(total_pop, join_by(health_board == health_board))|>left_join(fem_pop, join_by(health_board == health_board))|>left_join(male_pop, join_by(health_board == health_board))
df_ex<-external_combined|>filter(str_detect(Name, 'Total'))|>left_join(total_pop, join_by(health_board == health_board))|>left_join(fem_pop, join_by(health_board == health_board))|>left_join(male_pop, join_by(health_board == health_board))


##
comp_ext<-df_ex|>
  mutate(
    fec_100 = round((as.numeric(`Finished Consultant Episodes`) / as.numeric(main_total)) * 10000, 2),
    admi_100 = round((as.numeric(Admissions) / as.numeric(main_total)) * 10000, 2),
    emergency_100 = round((as.numeric(Emergency) / as.numeric(main_total)) * 10000, 2),
    male_100 = round((as.numeric(Male) / as.numeric(main_total_male)) * 10000, 2),
    female_100 = round((as.numeric(Female) / as.numeric(main_total_fem)) * 10000, 2)
  )|>
  select(`Finished Consultant Episodes`, 
         Admissions, 
         Male, 
         Female, 
         Emergency, 
         health_board, 
         disease_source, 
         resident_or_provider, 
         fec_100,
         admi_100, 
         emergency_100, 
         male_100,
         female_100)

comp_prim<-df_prim|>
  mutate(
    fec_100 = round((as.numeric(`Finished Consultant Episodes`) / as.numeric(main_total)) * 10000, 2),
    admi_100 = round((as.numeric(Admissions) / as.numeric(main_total)) * 10000, 2),
    emergency_100 = round((as.numeric(Emergency) / as.numeric(main_total)) * 10000, 2),
    male_100 = round((as.numeric(Male) / as.numeric(main_total_male)) * 10000, 2),
    female_100 = round((as.numeric(Female) / as.numeric(main_total_fem)) * 10000, 2)
  )|>
  select(`Finished Consultant Episodes`, 
         Admissions, 
         Male, 
         Female, 
         Emergency, 
         health_board, 
         disease_source, 
         resident_or_provider, 
         fec_100,
         admi_100, 
         emergency_100, 
         male_100,
         female_100)


combined_100<-union(comp_ext, comp_prim)
```


## {.sidebar}

<br> 

This dashboard displays statistics for Emergecnies in the 7 welsh NHS health boards from the 2023/2024 year.. it gotten from the official NHS Wales data repository. it also gets population data from https://statswales.gov.wales/. 




```{r}

 selectInput( 
    "HealthBoard", 
    "Select options below:", 
    choices = hb
  )

selectInput( 
    "Disease", 
    "Type of Disease Cause", 
    choices = c('Primary', 'External')
         , 
    multiple = FALSE 
  )

selectInput( 
    "RorP", 
    "Resident or Provider:", 
    choices = c('Health board Resident', 'Health board Provider'), 
    multiple = FALSE 
  )

conditionalPanel(
  condition = "input.Disease == 'Primary'",
  selectInput(
    "category",
    "Category of internal disease",
    choices = c("All", unique(primary_comb|>filter(!is.na(main_diag))|>pull(main_diag))) # or leave empty
  )
)

```

::: {.callout-note collapse="true"}
## Disclaimer

While data is not fictional care should be taekn to inpterpret it and its usage.
[NHS Data repository](https://phw.nhs.wales/data/)
[Stats Wales Page](https://statswales.gov.wales/Catalogue/Population-and-Migration/Population/Estimates/Small-Area).

:::

# Summary

## Row {height ="20%"}

```{r}

value_box(
  title= "Finished Consultant Episodes",
  showcase = bs_icon('hospital'),
  theme = 'teal',
  value =  textOutput('cosult'),
  showcase_layout = "top right"
)

```

```{r}

value_box(
  title= "Number of Admissions",
  showcase = bs_icon('hospital'),
  theme = 'pink',
  value =  textOutput('Admissions'),
  showcase_layout = "top right"
)

```

```{r}

value_box(
  title= "Mean Length of Stay",
  showcase = bs_icon('hospital'),
  theme = 'blue',
  value =  textOutput('stay'),
  showcase_layout = "top right"
)

```

```{r}

value_box(
  title= "Emergency",
  showcase = bs_icon('hospital'),
  theme = 'blue',
  value =  textOutput('emergency'),
  showcase_layout = "top right"
)

```


## Row {height="70%"}

### Column {width="40%"}

üè• **Key Concepts**

‚öïÔ∏è **Resident / Provider status**

- Provider-based figures: Include all patient episodes treated in Welsh hospitals, regardless of where the patient lives.

- Resident-based figures: Include all Welsh residents, whether treated in Wales or England. May contain codes not used in Wales until April 2016.

‚öïÔ∏è **Disease Type**

- Internal/Primary: These are conditions that arise from within the body, often due to physiological, genetic, or infectious processes

- External: external causes of injury, poisoning, and certain other consequence.

üìÖ Time

- Year: NHS financial year (April 1 ‚Äì March 31 2023).

üìå **Episode Types**

- FCEs (Finished Consultant Episodes):

- Time a patient spends under continuous care of one consultant.

- Includes inpatient, day case, and maternity consultant episodes.

üìå **Admissions (Admission Episodes)**:

First episode in a patient‚Äôs spell of care.

üë• **Demographics**

- Male/Female: FCEs by patient sex. Unknown/unspecified sex included in totals.

- Age Groups: Breakdown of Admission by age group.

- Mean Age: Average age at episode start.

üöë **Admission Method**

- Emergency: Admissions via emergency.

üöë Length of Stay (mean):

- Inpatient spells only.

- Calculated from admission ‚Üí discharge.



### Column {width="60%"}

```{r}
#| title: Top 5
plotOutput("top")
```

## Row {height="70%"}

### Column {width="50%" .tabset}

```{r}
#| title: Male
plotOutput("male")
```

```{r}
#| title: Female
plotOutput("female")
```

### Column {width="50%" .tabset}

```{r}
#| title: Age 0-14                   
plotOutput("fourteen")
```

```{r}
#| title: Age 15-59"                                 
plotOutput("fifteen")
```

```{r}
#| title: Age 60-74
plotOutput("sixty")
```

```{r}
#| title: Age 75+
plotOutput("sevenfive")
```

# Comparison

## Row {height ="20%"}

Compare different health boards 

This section compares values per 10,000 people, where indicated. Population data is taken from the 2021 Census and reflects the counties served by the different health boards. Using metrics per 10,000 provides a way to move beyond the raw figures and adds context to the numbers.


## Row {height ="60%"}

```{r}
#| content: card-toolbar

selectInput( 
    "HealthBoardtwo", 
    "Select options below:", 
    choices = hb
  )

selectInput( 
    "Diseasetwo", 
    "Type of Disease Cause", 
    choices = c('Primary', 'External')
         , 
    multiple = FALSE 
  )

selectInput( 
    "RorPtwo", 
    "Resident or Provider:", 
    choices = c('Health board Resident', 'Health board Provider'), 
    multiple = FALSE 
  )

```

```{r}
#| title: Comparison
plotOutput("comparison")
```


```{r}
#| context: server

total_table <- reactive({
  if(input$Disease == "Primary"){
    df_prim|>filter(health_board == input$HealthBoard & resident_or_provider == input$RorP)
  }else{
    df_ex|>filter(health_board == input$HealthBoard & resident_or_provider == input$RorP)
  }
  
})


output$Admissions<-renderText(
  {sum(as.numeric(total_table()$Admissions))}
)

output$stay<-renderText(
  {round(sum(as.numeric(total_table()$`Mean Length of Stay`)), 2)}
)

output$cosult<-renderText(
  {sum(as.numeric(total_table()$`Finished Consultant Episodes`))}
)

output$emergency<-renderText(
  {sum(as.numeric(total_table()$Emergency))}
)

#for plots
total_table_plot_tot <- reactive({
  if(input$Disease == "Primary" & input$category != 'All'){
    primary_comb|>
    filter(health_board == input$HealthBoard & Name!='Total Episodes'& resident_or_provider == input$RorP &  DiagnosisType==input$category)|>select(Admissions, Name, Male, Female, `Age 0-14`, `Age 15-59`, `Age 60-74`, `Age 75+`)|>
      mutate(Admissions = as.numeric(Admissions),
             Male = as.numeric(Male),
             Female = as.numeric(Female),
             `Age 0-14` = as.numeric(`Age 0-14`),
             `Age 15-59` = as.numeric(`Age 15-59`),
             `Age 60-74` = as.numeric(`Age 60-74`),
             `Age 75+` = as.numeric(`Age 75+`),
             
             )|>
      arrange(desc(Admissions))|>
      slice(1:5)|>mutate(Name = factor(Name, levels = Name)) 
  }
  else if (input$Disease == "Primary" & input$category == 'All'){
    primary_comb|>
    filter(health_board == input$HealthBoard & Name!='Total Episodes'& resident_or_provider == input$RorP)|>
      select(Admissions, Name, Male, Female, `Age 0-14`, `Age 15-59`, `Age 60-74`, `Age 75+`)|>
      mutate(Admissions = as.numeric(Admissions),
             Male = as.numeric(Male),
             Female = as.numeric(Female),
             `Age 0-14` = as.numeric(`Age 0-14`),
             `Age 15-59` = as.numeric(`Age 15-59`),
             `Age 60-74` = as.numeric(`Age 60-74`),
             `Age 75+` = as.numeric(`Age 75+`),
             
             )|>
      arrange(desc(Admissions))|>
      slice(1:5)
  }
  else{
    external_combined|>
      filter(health_board == input$HealthBoard & Name!='Total External Causes' & resident_or_provider == input$RorP)|>
      select(Admissions, Name, Male, Female, `Age 0-14`, `Age 15-59`, `Age 60-74`, `Age 75+`)|>
      mutate(Admissions = as.numeric(Admissions),
             Male = as.numeric(Male),
             Female = as.numeric(Female),
             `Age 0-14` = as.numeric(`Age 0-14`),
             `Age 15-59` = as.numeric(`Age 15-59`),
             `Age 60-74` = as.numeric(`Age 60-74`),
             `Age 75+` = as.numeric(`Age 75+`),
             
             )|>      
      arrange(desc(Admissions))|>
      slice(1:5)
  }

})

output$top <- renderPlot({
  ggplot(total_table_plot_tot()) + 
  geom_bar(aes(x = reorder(Name, -Admissions), y= Admissions, fill = Name), stat = 'identity', width = 0.5) + 
  
  scale_fill_manual(values = colors) + 
  scale_y_continuous(breaks = seq(0, 6000, 500)) +
  theme_custom() + 
  theme(axis.text.x = element_blank(), 
        legend.text = element_text(size = 10,hjust = 0.5, lineheight = 121), legend.position = "bottom",
        legend.title = element_blank()) + 
  guides(fill = guide_legend(nrow = 3))
})

output$male <- renderPlot({
  ggplot(total_table_plot_tot()) + 
  geom_bar(aes(x = reorder(Name, -Male), y= Male, fill = Name), stat = 'identity', width = 0.5) + 
  
  scale_fill_manual(values = colors) + 
  scale_y_continuous(breaks = seq(0, 3000, 500)) +
  theme_custom() + 
  theme(axis.text.x = element_blank(), 
        legend.text = element_text(size = 10,hjust = 0.5, lineheight = 121), legend.position = "bottom",
        legend.title = element_blank()) + 
  guides(fill = guide_legend(nrow = 3))
})

output$female <- renderPlot({
  ggplot(total_table_plot_tot()) + 
  geom_bar(aes(x = reorder(Name, -Female), y= Female, fill = Name), stat = 'identity', width = 0.5) + 
  
  scale_fill_manual(values = colors) + 
  scale_y_continuous(breaks = seq(0, 3000, 500)) +
  theme_custom() + 
  theme(axis.text.x = element_blank(), 
        legend.text = element_text(size = 10,hjust = 0.5, lineheight = 121), legend.position = "bottom",
        legend.title = element_blank()) + 
  guides(fill = guide_legend(nrow = 3))
})


output$fourteen <- renderPlot({
  ggplot(total_table_plot_tot()) + 
  geom_bar(aes(x = reorder(Name, -`Age 0-14`), y= `Age 0-14`, fill = Name), stat = 'identity', width = 0.5) + 
  
  scale_fill_manual(values = colors) + 
  scale_y_continuous(breaks = seq(0, 3000, 500)) +
  theme_custom() + 
  theme(axis.text.x = element_blank(), 
        legend.text = element_text(size = 10,hjust = 0.5, lineheight = 121), legend.position = "bottom",
        legend.title = element_blank()) + 
  guides(fill = guide_legend(nrow = 3))
})

output$fifteen <- renderPlot({
  ggplot(total_table_plot_tot()) + 
  geom_bar(aes(x = reorder(Name, -`Age 15-59`), y= `Age 15-59`, fill = Name), stat = 'identity', width = 0.5) + 
  
  scale_fill_manual(values = colors) + 
  scale_y_continuous(breaks = seq(0, 3000, 500)) +
  theme_custom() + 
  theme(axis.text.x = element_blank(), 
        legend.text = element_text(size = 10,hjust = 0.5, lineheight = 121), legend.position = "bottom",
        legend.title = element_blank()) + 
  guides(fill = guide_legend(nrow = 3))
})

output$sixty <- renderPlot({
  ggplot(total_table_plot_tot()) + 
  geom_bar(aes(x = reorder(Name, -`Age 60-74`), y= `Age 60-74`, fill = Name), stat = 'identity', width = 0.5) + 
  
  scale_fill_manual(values = colors) + 
  scale_y_continuous(breaks = seq(0, 3000, 500)) +
  theme_custom() + 
  theme(axis.text.x = element_blank(), 
        legend.text = element_text(size = 10,hjust = 0.5, lineheight = 121), legend.position = "bottom",
        legend.title = element_blank()) + 
  guides(fill = guide_legend(nrow = 3))
})

output$sevenfive <- renderPlot({
  ggplot(total_table_plot_tot()) + 
  geom_bar(aes(x = reorder(Name, -`Age 75+`), y= `Age 75+`, fill = Name), stat = 'identity', width = 0.5) + 
  
  scale_fill_manual(values = colors) + 
  scale_y_continuous(breaks = seq(0, 3000, 500)) +
  theme_custom() + 
  theme(axis.text.x = element_blank(), 
        legend.text = element_text(size = 10,hjust = 0.5, lineheight = 121), legend.position = "bottom",
        legend.title = element_blank()) + 
  guides(fill = guide_legend(nrow = 3))
})

# observeEvent(input$Disease, {
#   if (input$Disease == "Internal") {
#     updateSelectInput(
#       session,
#       inputId = "category",
#       label = "Category of internal disease",
#       choices = c("All", unique(primary_comb$DiagnosisType))
#     )
#   } else if (input$Disease == "External") {
#     updateSelectInput(
#       session,
#       inputId = "category",
#       label = "Category of internal disease",
#       choices = NULL
#     )
#   }
# })


###page 2
##get the long data

long<- reactive({
  left_filters<-combined_100|>
    filter(health_board == input$HealthBoard & disease_source == input$Disease & resident_or_provider == input$RorP)|>
    select(-c(disease_source, resident_or_provider, health_board))|>
    mutate_all(function(x) as.numeric(as.character(x)))|>
    pivot_longer(everything(),names_to = 'metric', values_to = 'value')|>mutate(name = "Left")
  
  right_filters<-combined_100|>
    filter(health_board == input$HealthBoardtwo & disease_source == input$Diseasetwo & resident_or_provider == input$RorPtwo)|>
    select(-c(disease_source, resident_or_provider, health_board))|>
    mutate_all(function(x) as.numeric(as.character(x)))|>
    pivot_longer(everything(),names_to = 'metric', values_to = 'value')|>mutate(name = "Right")
  
  long<-union(left_filters, right_filters)
  
  long$metric<-factor(long$metric, levels = c("Finished Consultant Episodes", "fec_100", "Admissions" , "admi_100", "Emergency", 
                                              "emergency_100" , "Female" , "female_100", "Male","male_100" ))
  
  long
  
})

long_main<-reactive(
  {
    long()|>pivot_wider(names_from = name, values_from = value)|>
      mutate(dif = Left - Right)|>
      group_by(metric)|>
      mutate(max = max(Left, Right))|>
      ungroup()|>
      pivot_longer(c(Left, Right))
  }
)

wide<-reactive(
  {
   long()|>
      pivot_wider(names_from = name, values_from = value)|>
      mutate(dif = Left - Right)|>
      group_by(metric)|>
      mutate(max = max(Left, Right))|>
      ungroup()
  }
)


output$comparison <- renderPlot({

  df_main <- long_main()

  df_main <- df_main |>
    mutate(
      nudge_x = ifelse(value == max, 0.6, -0.6),
      vjust_pos = ifelse(value == max, -0.9, 2)
    )

  p_main <- ggplot(df_main, aes(x = value, y = metric)) +
    geom_line(aes(group = metric), color = "#E7E7E7", linewidth = 3.5) +
    geom_point(aes(color = name), size = 3) +
    geom_text(aes(label = value, color = name, 
                  nudge_x = nudge_x, vjust = vjust_pos), size = 5) +
    theme_custom() +
    theme(
      legend.position = "none",
      axis.text.y = element_text(color = "black", margin = margin(r = 15)),
      axis.text.x = element_text(color = "#989898"),
      axis.title = element_blank()
    ) +
    scale_color_manual(values = c("#436685", "#BF2F24")) +
    scale_y_discrete(
      limits = rev(levels(long()$metric)),
      labels = c(
        "fec_100" = "Finished Consultant Episodes per 10000",
        "admi_100" = "Admissions per 10000", 
        "emergency_100" = "Emergency per 10000",
        "male_100" = "Male Admissions per 10000",
        "female_100" = "Female Admissions per 10000"
      )
    )

  p_gap <- wide() |>
    ggplot(aes(x = dif, y = metric)) + 
    geom_text(aes(x = 0, label = dif), fontface = "bold", size = 5) +
    geom_text(aes(x = 0, y = 10), label = "Difference", nudge_y = 0.5,
              fontface = "bold", size = 5) +
    scale_y_discrete(limits = rev(levels(wide()$metric))) + 
    theme_void() +
    coord_cartesian(xlim = c(-0.05, 0.05)) +
    theme(
      plot.margin = margin(l = 0, r = 0, b = 0, t = 0),
      panel.background = element_rect(fill = "#EFEFE3", color = "#EFEFE3"),
      legend.position = "none"
    )

  p_main + p_gap + patchwork::plot_layout(
    design = c(
      patchwork::area(l = 0,  r = 45, t = 0, b = 1),
      patchwork::area(l = 46, r = 52, t = 0, b = 1)
    )
  )
})






```
