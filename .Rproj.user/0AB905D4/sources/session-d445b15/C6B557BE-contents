get_data<-function(df){
  
  health_board <- c(
    "Aneurin Bevan University Health Board",
    "Aneurin Bevan University Health Board",
    "Aneurin Bevan University Health Board",
    "Aneurin Bevan University Health Board",
    "Aneurin Bevan University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Betsi Cadwaladr University Health Board",
    "Cardiff and Vale University Health Board",
    "Cardiff and Vale University Health Board",
    "Cwm Taf Morgannwg University Health Board",
    "Cwm Taf Morgannwg University Health Board",
    "Cwm Taf Morgannwg University Health Board",
    "Hywel Dda University Health Board",
    "Hywel Dda University Health Board",
    "Hywel Dda University Health Board",
    "Powys Teaching Health Board",
    "Swansea Bay University Health Board",
    "Swansea Bay University Health Board"
  )
  
  area_served <- c(
    "Blaenau Gwent",
    "Caerphilly",
    "Monmouthshire",
    "Newport",
    "Torfaen",
    "Anglesey",
    "Gwynedd",
    "Conwy",
    "Denbighshire",
    "Flintshire",
    "Wrexham",
    "Cardiff",
    "Vale of Glamorgan",
    "Bridgend",
    "Merthyr Tydfil",
    "Rhondda Cynon Taf",
    "Carmarthenshire",
    "Ceredigion",
    "Pembrokeshire",
    "Powys",
    "Swansea",
    "Neath Port Talbot"
  )
  
  # Create the data frame
  welsh_health_boards <- data.frame(
    health_board = health_board,
    area_served = area_served
  )
  
  main_df<-df|>rename(local_authority = "...2", 
                      local_auth_two = "...3",
                      Zero_to_fifteen =  "All ages...4",
                      sixteen_to_sixtyfour = "...5",
                      SixtyFive_and_over =  "...6" ,
                      Total = "All ages...7")|>
    select (local_authority:Total)|>
    slice(3:n())|>
    rowwise() %>%
    mutate(main_local = case_when(
      is.na(local_auth_two) & !is.na(local_authority) ~ local_authority,
      .default = str_trim(str_split(local_auth_two, 'U')[[1]][1])
    )) %>%
    
    mutate(main_local = case_when(
      main_local == "The Vale of Glamorgan" ~ "Vale of Glamorgan",
      main_local == "Isle of Anglesey" ~ 'Anglesey',
      main_local == "Rhondda Cynon Taff"  ~ "Rhondda Cynon Taf"  ,
      .default = main_local
    )) |>
    # Remove the rowwise structure
    ungroup() |>
    select (main_local, Zero_to_fifteen, sixteen_to_sixtyfour, SixtyFive_and_over, Total)|>
    group_by(main_local)|>
    summarise(
      Zero_to_fifteen = sum(as.numeric(Zero_to_fifteen)),
      sixteen_to_sixtyfour = sum(as.numeric(sixteen_to_sixtyfour)),
      SixtyFive_and_over = sum(as.numeric(SixtyFive_and_over)),
      Total = sum(as.numeric(Total))
    ) |>ungroup()|>
    left_join(welsh_health_boards, join_by(main_local == area_served))
  
  
  return(
    main_df
  )
}
get_data_from_nhs<-function(data_location){
  
  health_boards<-c("Aneurin Bevan ULHB", 
                   'Betsi Cadwaladr ULHB', 
                   'Cardiff & Vale ULHB',
                   'Cwm Taf Morgannwg ULHB',
                   'Hywel Dda ULHB',
                   'Powys Teaching LHB',
                   'Swansea Bay ULHB')
  combined_df <- map_dfr(health_boards,
                         ~read_excel(data_location, sheet = .x, skip = 3)|>slice(2:n())|>
                           mutate(health_board = 
                                    case_when(
                                      .x == 'Cardiff & Vale ULHB'~ str_replace((str_replace(.x, '&', 'and')), 'ULHB', 'University Health Board'),
                                      .default = str_replace(.x, 'ULHB', 'University Health Board'))
                           )
  )
  
}

fem_pop<-get_data(read_excel("data/female.xlsx"))
male_pop <- get_data(read_excel("data/males.xlsx"))
total_pop<-get_data(read_excel("data/total.xlsx"))


external_disease_health_resident<-get_data_from_nhs("data/ExcelTables11R_2023_LHB.xlsx")






library(readxl)
ExcelTables11R_2023_LHB <- read_excel("data/ExcelTables11R_2023_LHB.xlsx", 
                                      sheet = "Aneurin Bevan ULHB", skip = 3)
ExcelTables11R_2023_LHB|>mutate(health_board =  str_replace("Aneurin Bevan ULHB", 'ULHB', 'University Health Board') )


test<-c("Aneurin Bevan ULHB", 'Betsi Cadwaladr ULHB', 'Cardiff & Vale ULHB','Cwm Taf Morgannwg ULHB','Hywel Dda ULHB',"Powys Teaching LHB",'Swansea Bay ULHB')
combined_df <- map_dfr(
  test,
  ~ read_excel("data/ExcelTables11R_2023_LHB.xlsx", sheet = .x, skip = 3) |>
    mutate(
      health_board = case_when(
        .x == "Cardiff & Vale ULHB" ~ str_replace(str_replace(.x, "&", "and"), "ULHB", "University Health Board"),
        TRUE ~ str_replace(.x, "ULHB", "University Health Board")
      )
    )
)


library(readxl)
ExcelTables11R_2023_LHB <- read_excel("data/ExcelTables11R_2023_LHB.xlsx", 
                                      sheet = "Aneurin Bevan ULHB", skip = 4)
View(ExcelTables11R_2023_LHB)